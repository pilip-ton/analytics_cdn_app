<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytics CDN Checker</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Eruda Console -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    #status-container > div {
      padding: 10px;
      background: #e0e0e0;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
<h1>Analytics CDN Checker</h1>

<div id="status-container">
  <div id="first-cdn-status">âŒ› Waiting for primary CDN...</div>
  <div id="second-cdn-status">âŒ› Waiting for secondary CDN...</div>
  <div id="init-status">âŒ› Waiting for analytics initialization...</div>
  <div id="event-status">âŒ› Waiting for analytics event...</div>
</div>

<script>
  // Telegram WebApp SDK init
  window.Telegram.WebApp.ready();
  const tg = window.Telegram.WebApp;
  tg.expand(); // Optional: expand the app to full height

  console.log('Telegram WebApp platform:', tg.platform);
  console.log('Telegram initData:', tg.initData);

  // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
  function updateStatus(id, message, className) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.className = className;
  }

  // Intercept fetch and XMLHttpRequest for /events monitoring
  (function interceptAnalyticsRequests() {
    const originalFetch = window.fetch;
    window.fetch = async function (...args) {
      const url = args[0];
      if (typeof url === 'string' && url.includes('/events')) {
        const response = await originalFetch.apply(this, args);
        if ([200, 201, 203].includes(response.status)) {
          updateStatus('event-status', 'âœ… Analytics event sent', 'success');
        } else {
          updateStatus('event-status', `âŒ Analytics event failed (status ${response.status})`, 'error');
        }
        return response;
      }
      return originalFetch.apply(this, args);
    };

    const originalXhrOpen = XMLHttpRequest.prototype.open;
    const originalXhrSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function (method, url) {
      this._isAnalyticsEvent = url.includes('/events');
      return originalXhrOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function () {
      if (this._isAnalyticsEvent) {
        this.addEventListener('load', function () {
          if ([200, 201, 203].includes(this.status)) {
            updateStatus('event-status', 'âœ… Analytics event sent', 'success');
          } else {
            updateStatus('event-status', `âŒ Analytics event failed (status ${this.status})`, 'error');
          }
        });
      }
      return originalXhrSend.apply(this, arguments);
    };
  })();

  const MAX_RETRIES = 3;
  const RETRY_DELAY_MS = 1000;

  let firstCdnLoaded = false;
  let secondCdnLoaded = false;
  let analyticsInitialized = false;

  function checkAllLoaded() {
    if (firstCdnLoaded || secondCdnLoaded) {
      initAnalytics();
    } else if (!firstCdnLoaded && !secondCdnLoaded) {
      updateStatus('init-status', 'âŒ All CDNs failed to load', 'error');
    }
  }

  function initAnalytics() {
    if (analyticsInitialized) return;
    if (window.telegramAnalytics) {
      window.telegramAnalytics.init({
        token: 'eyJhcHBfbmFtZSI6ImRldmVsb3BlclRlc3QiLCJhcHBfdXJsIjoiaHR0cHMvL3QubWUvQm90RmF0aGVyIiwiYXBwX2RvbWFpbiI6Imh0dHBzOi8vdGdhbmFseXRpY3MueHl6In0=!IvfqLr4Z8W8rwExUqUzkOW2Nzy9aeCf2cNAhbFTWLFI=',
        appName: 'developerTest',
      });
      analyticsInitialized = true;
      updateStatus('init-status', 'âœ… Wow! Analytics initialized successfully', 'success');
    } else {
      updateStatus('init-status', 'âŒ Analytics initialization failed', 'error');
    }
  }

  function loadScriptWithRetry({ src, id, successCallback, errorCallback, statusId }) {
    let attempts = 0;
    const startTime = performance.now();

    function tryLoad() {
      const script = document.createElement('script');
      script.async = true;

      // ðŸ”¥ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð´Ð»Ñ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÑÑˆÐ°
      const uniqueParam = `nocache=${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      script.src = `${src}?${uniqueParam}&retry=${attempts}`;
      script.id = id;

      script.onload = () => {
        const duration = (performance.now() - startTime).toFixed(2);
        successCallback();
        updateStatus(
          statusId,
          `âœ… Loaded in ${attempts + 1} attempt(s) â€” ${duration} ms`,
          'success'
        );
      };

      script.onerror = (e) => {
        attempts++;
        if (attempts < MAX_RETRIES) {
          updateStatus(statusId, `âš ï¸ Retry ${attempts}/${MAX_RETRIES} for ${id}`, 'error');
          setTimeout(tryLoad, RETRY_DELAY_MS);
        } else {
          const duration = (performance.now() - startTime).toFixed(2);
          const errorMsg = e?.message || 'Unknown error';
          errorCallback();
          updateStatus(
            statusId,
            `âŒ Failed after ${attempts} attempts. (${duration} ms) Error: ${errorMsg}`,
            'error'
          );
        }
      };

      document.body.appendChild(script);
    }

    tryLoad();
  }

  // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° CDN-ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² Ñ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ ÐºÑÑˆÐ°
 loadScriptWithRetry({
    src: 'https://files.catbox.moe/c1rxcw.js',
    id: 'first-cdn',
    successCallback: () => { firstCdnLoaded = true; checkAllLoaded(); },
    errorCallback: () => { firstCdnLoaded = false; checkAllLoaded(); },
    statusId: 'first-cdn-status'
  });

  loadScriptWithRetry({
    src: 'https://files.catbox.moe/c1rxcw.js',
    id: 'second-cdn',
    successCallback: () => { secondCdnLoaded = true; checkAllLoaded(); },
    errorCallback: () => { secondCdnLoaded = false; checkAllLoaded(); },
    statusId: 'second-cdn-status'
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytics CDN Checker</title>
  <!-- Eruda Console -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    #status {
      padding: 10px;
      background: #e0e0e0;
      border-radius: 8px;
      margin-top: 20px;
      font-weight: bold;
    }
    .cdn-status {
      padding: 10px;
      background: #e0e0e0;
      border-radius: 8px;
      margin-top: 10px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>Analytics CDN Checker</h1>
  <div id="first-cdn-status" class="cdn-status">⌛ Waiting for primary CDN...</div>
  <div id="second-cdn-status" class="cdn-status">⌛ Waiting for secondary CDN...</div>
  <div id="status">⌛ Waiting for analytics initialization...</div>
  
  <script>
  const MAX_RETRIES = 3;
  const RETRY_DELAY_MS = 1000;

  let firstCdnLoaded = false;
  let secondCdnLoaded = false;

  function updateStatus(id, message, className) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.className = `cdn-status ${className}`;
  }

  function checkAllLoaded() {
    const mainStatus = document.getElementById('status');
    if (firstCdnLoaded || secondCdnLoaded) {
      initAnalytics();
    } else if (!firstCdnLoaded && !secondCdnLoaded) {
      mainStatus.textContent = '❌ All CDNs failed to load';
      mainStatus.className = 'error';
    }
  }

  function initAnalytics() {
    if (window.telegramAnalytics) {
      window.telegramAnalytics.init({
        token: 'eyJhcHBfbmFtZSI6ImNkbl9tZWdhX3Rlc3QiLCJhcHBfdXJsIjoiaHR0cHM6Ly90Lm1lL2Nkbm1lZ2F0ZXN0X2JvdCIsImFwcF9kb21haW4iOiJodHRwczovL21pbmktYXBwLWIyNy5wYWdlcy5kZXYvIn0=!PtMj5SqGQ6UYEgiggPKqmbHwj/bO4pvYWvnpQ/xvl0g=',
        appName: 'cdn_mega_test',
      });
      updateStatus('status', '✅ Analytics initialized successfully', 'success');
    } else {
      updateStatus('status', '❌ Analytics initialization failed', 'error');
    }
  }

  function loadScriptWithRetry({ src, id, successCallback, errorCallback, statusId }) {
    let attempts = 0;

    function tryLoad() {
      const script = document.createElement('script');
      script.async = true;
      script.src = src + `?retry=${attempts}`; // prevent caching
      script.id = id;

      script.onload = () => {
        successCallback();
        updateStatus(statusId, `✅ Loaded in ${attempts + 1} attempt(s)`, 'success');
      };

      script.onerror = (e) => {
        attempts++;
        if (attempts < MAX_RETRIES) {
          updateStatus(statusId, `⚠️ Retry ${attempts}/${MAX_RETRIES} for ${id}`, 'error');
          setTimeout(tryLoad, RETRY_DELAY_MS);
        } else {
          const errorMsg = e?.message || 'Unknown error';
          errorCallback();
          updateStatus(statusId, `❌ Failed after ${attempts} attempts. Error: ${errorMsg}`, 'error');
        }
      };

      document.body.appendChild(script);
    }

    tryLoad();
  }

  loadScriptWithRetry({
    src: 'https://tganalytics.xyz/index.js',
    id: 'first-cdn',
    successCallback: () => { firstCdnLoaded = true; checkAllLoaded(); },
    errorCallback: () => { firstCdnLoaded = false; checkAllLoaded(); },
    statusId: 'first-cdn-status'
  });

  loadScriptWithRetry({
    src: 'https://cdn.tganalytics.xyz/index.js',
    id: 'second-cdn',
    successCallback: () => { secondCdnLoaded = true; checkAllLoaded(); },
    errorCallback: () => { secondCdnLoaded = false; checkAllLoaded(); },
    statusId: 'second-cdn-status'
  });
</script>
</body>
</html>
